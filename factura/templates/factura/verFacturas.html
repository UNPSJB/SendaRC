{% extends 'layouts/baseGestion.html' %}
{% load static %}
{% block titleNavegador %}SendaRC - Gestión de Facturas{% endblock %}
{% block title %}
<div class="seccion-cabecera animate-fade-in">
    <div class="header-content">
        <div class="header-left">
            <h1>Todas las Facturas</h1>
            <p>Consulte y administre todas las facturas del sistema</p>
        </div>
        <div class="header-actions">
            <a href="javascript:history.back()" class="btn btn-primary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Volver
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block listado %}
<div class="facturas-list-layout">
    <!-- Estadísticas rápidas -->
    <div class="stats-section">
        <div class="stats-grid">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="stat-content">
                        <div class="stat-icon total">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value">{{ total_facturas }}</div>
                            <div class="stat-label">Total Facturas</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card stat-card">
                <div class="card-body">
                    <div class="stat-content">
                        <div class="stat-icon paid">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value">{{ facturas_pagadas }}</div>
                            <div class="stat-label">Pagadas</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card stat-card">
                <div class="card-body">
                    <div class="stat-content">
                        <div class="stat-icon pending">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value">{{ facturas_pendientes }}</div>
                            <div class="stat-label">Pendientes</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card stat-card">
                <div class="card-body">
                    <div class="stat-content">
                        <div class="stat-icon overdue">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="16"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value">{{ facturas_vencidas }}</div>
                            <div class="stat-label">Vencidas</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros y búsqueda -->
    <div class="filters-section">
        <div class="card">
            <div class="card-body">
                <form method="GET" class="filters-form">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="form-label">Buscar</label>
                            <input type="text" name="search" class="form-control" placeholder="Cliente, servicio..." value="{{ request.GET.search }}">
                        </div>
                        <div class="filter-group">
                            <label class="form-label">Tipo de Factura</label>
                            <select name="tipo" class="form-control">
                                <option value="">Todos los tipos</option>
                                <option value="1" {% if request.GET.tipo == '1' %}selected{% endif %}>Seña</option>
                                <option value="2" {% if request.GET.tipo == '2' %}selected{% endif %}>Única</option>
                                <option value="3" {% if request.GET.tipo == '3' %}selected{% endif %}>Mensual</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="form-label">Estado</label>
                            <select name="estado" class="form-control">
                                <option value="">Todos los estados</option>
                                <option value="pagada" {% if request.GET.estado == 'pagada' %}selected{% endif %}>Pagada</option>
                                <option value="pendiente" {% if request.GET.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                                <option value="vencida" {% if request.GET.estado == 'vencida' %}selected{% endif %}>Vencida</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="form-label">Fecha Emisión Desde</label>
                            <input type="date" name="fecha_emision_desde" class="form-control" value="{{ request.GET.fecha_emision_desde }}">
                        </div>
                        <div class="filter-group">
                            <label class="form-label">Fecha Emisión Hasta</label>
                            <input type="date" name="fecha_emision_hasta" class="form-control" value="{{ request.GET.fecha_emision_hasta }}">
                        </div>
                        <div class="filter-group">
                            <label class="form-label">Fecha Vencimiento Desde</label>
                            <input type="date" name="fecha_vencimiento_desde" class="form-control" value="{{ request.GET.fecha_vencimiento_desde }}">
                        </div>
                        <div class="filter-group">
                            <label class="form-label">Fecha Vencimiento Hasta</label>
                            <input type="date" name="fecha_vencimiento_hasta" class="form-control" value="{{ request.GET.fecha_vencimiento_hasta }}">
                        </div>
                        <div class="filter-group">
                            <button type="submit" class="btn btn-primary">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="m21 21-4.35-4.35"></path>
                                </svg>
                                Filtrar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tabla de facturas -->
    <div class="table-section">
        <div class="table-container">
            {% if facturas %}
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID Factura</th>
                            <th>Cliente</th>
                            <th>Id Servicio</th>
                            <th>Tipo</th>
                            <th>Importe</th>
                            <th>Fecha Emisión</th>
                            <th>Fecha Vencimiento</th>
                            <th>Período Servicio</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for factura in facturas %}
                        <tr>
                            <td>
                                <strong>#{{ factura.id }}</strong>
                            </td>
                            <td>
                                <div class="client-info">
                                    <div class="client-name">{{ factura.cliente.nombre }} {{ factura.cliente.apellido }}</div>
                                </div>
                            </td>
                            <td>{{ factura.servicio.pk }}</td>
                            <td>{{ factura.getTipo }}</td>
                            <td>
                                <strong class="amount-cell">{{ factura.getImporteFormateado }}</strong>
                            </td>
                            <td>{{ factura.fechaEmision|date:"d/m/Y" }}</td>
                            <td>{{ factura.fecha_vencimiento|date:"d/m/Y" }}</td>
                            <td>{{ factura.getPeriodoServicio }}</td>
                            <td>
                                {% if factura.fechaPago %}
                                    <span class="badge badge-pagada">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                        Pagada
                                    </span>
                                {% elif factura.fecha_vencimiento and factura.fecha_vencimiento < today %}
                                    <span class="badge badge-vencida">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="12" y1="8" x2="12" y2="16"></line>
                                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                        </svg>
                                        Vencida
                                    </span>
                                {% else %}
                                    <span class="badge badge-pendiente">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <polyline points="12 6 12 12 16 14"></polyline>
                                        </svg>
                                        Pendiente
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="row-actions">
                                    <a href="{% url 'detalleFactura' factura.pk %}"  class="btn btn-outline-primary btn-sm" title="Ver detalles Factura" data-bs-toggle="tooltip" data-bs-placement="top">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                    </a>
                                    <a target="_blank" href="{% url 'pdf_factura' factura.pk %}" class="btn btn-outline-primary btn-sm" title="Imprimir Factura" data-bs-toggle="tooltip" data-bs-placement="top">
                                        <i class="bi bi-printer"></i>
                                    </a>
                                    {% if not factura.fechaPago %}
                                    <a href="{% url 'formaPago' factura.pk %}" class="btn btn-primary btn-sm" title="Registrar pago" data-bs-toggle="tooltip" data-bs-placement="top">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="2" y="6" width="20" height="12" rx="2" ry="2" />
                                            <circle cx="12" cy="12" r="3" />
                                            <path d="M2 9a3 3 0 0 0 3 3 3 3 0 0 1-3 3" />
                                            <path d="M22 9a3 3 0 0 1-3 3 3 3 0 0 0 3 3" />
                                        </svg>
                                    </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="empty-state">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    <h3>No se encontraron facturas</h3>
                    <p>No hay facturas que coincidan con los criterios de búsqueda</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Paginación -->
    {% if facturas.has_other_pages %}
    <div class="pagination-section">
        <div class="card">
            <div class="card-body">
                <div class="pagination-container">
                    <div class="pagination-info">
                        Mostrando {{ facturas.start_index }} - {{ facturas.end_index }} de {{ facturas.paginator.count }} facturas
                    </div>
                    <div class="pagination-controls">
                        {% if facturas.has_previous %}
                            <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}{% if request.GET.fecha_desde %}&fecha_desde={{ request.GET.fecha_desde }}{% endif %}{% if request.GET.fecha_hasta %}&fecha_hasta={{ request.GET.fecha_hasta }}{% endif %}" class="btn btn-outline-primary btn-sm">Primera</a>
                            <a href="?page={{ facturas.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}{% if request.GET.fecha_desde %}&fecha_desde={{ request.GET.fecha_desde }}{% endif %}{% if request.GET.fecha_hasta %}&fecha_hasta={{ request.GET.fecha_hasta }}{% endif %}" class="btn btn-outline-primary btn-sm">Anterior</a>
                        {% endif %}
                        
                        <span class="btn btn-primary btn-sm">{{ facturas.number }}</span>
                        
                        {% if facturas.has_next %}
                            <a href="?page={{ facturas.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}{% if request.GET.fecha_desde %}&fecha_desde={{ request.GET.fecha_desde }}{% endif %}{% if request.GET.fecha_hasta %}&fecha_hasta={{ request.GET.fecha_hasta }}{% endif %}" class="btn btn-outline-primary btn-sm">Siguiente</a>
                            <a href="?page={{ facturas.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}{% if request.GET.fecha_desde %}&fecha_desde={{ request.GET.fecha_desde }}{% endif %}{% if request.GET.fecha_hasta %}&fecha_hasta={{ request.GET.fecha_hasta }}{% endif %}" class="btn btn-outline-primary btn-sm">Última</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
/* Estilos específicos para verFacturas que complementan base-styles.css */

.facturas-list-layout {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    margin-top: 1.5rem;
}

/* Header */
.header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 2rem;
    flex-wrap: wrap;
}

.header-left h1 {
    margin-bottom: 0.5rem;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
}

/* Stats section */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
}

.stat-card .card-body {
    padding: 1.25rem;
}

.stat-content {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.stat-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.stat-icon.total {
    background: hsl(var(--accent) / 0.1);
    color: hsl(var(--accent));
}

.stat-icon.paid {
    background: hsl(var(--success) / 0.1);
    color: hsl(var(--success));
}

.stat-icon.pending {
    background: hsl(var(--warning) / 0.1);
    color: hsl(var(--warning));
}

.stat-icon.overdue {
    background: hsl(var(--destructive) / 0.1);
    color: hsl(var(--destructive));
}

.stat-info {
    flex: 1;
}

.stat-value {
    font-size: 1.875rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
    color: hsl(var(--foreground));
}

.stat-label {
    font-size: 0.875rem;
    color: hsl(var(--muted-foreground));
    margin: 0;
}

/* Filters section */
.filters-form {
    margin: 0;
}

.filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

/* Table section */
.client-info {
    display: flex;
    flex-direction: column;
}

.client-name {
    font-weight: 500;
    color: hsl(var(--foreground));
}

.amount-cell {
    color: hsl(var(--accent));
}


/* Row actions */
.row-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    height: auto;
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: hsl(var(--muted-foreground));
}

.empty-state svg {
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state h3 {
    margin: 0 0 0.5rem 0;
    color: hsl(var(--foreground));
}

.empty-state p {
    margin: 0;
}

/* Pagination */
.pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.pagination-info {
    color: hsl(var(--muted-foreground));
    font-size: 0.875rem;
}

.pagination-controls {
    display: flex;
    gap: 0.5rem;
}

/* Responsive */
@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        align-items: stretch;
    }
    
    .header-actions {
        justify-content: space-between;
    }
    
    .filters-grid {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .pagination-container {
        flex-direction: column;
        text-align: center;
    }
    
    .table-container {
        overflow-x: auto;
    }
    
    .table {
        min-width: 100%;
    }
}

@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .row-actions {
        flex-direction: column;
    }
}
</style>
{% endblock %}
{% block extrajs %}
<script>
$(function() {
    // Animación de entrada para las filas de la tabla
    $('.table tbody tr').each(function(index) {
        $(this).css('animation-delay', (index * 0.05) + 's');
        $(this).addClass('animate-fade-in');
    });
    
    // Animación para las stats
    $('.stat-card').each(function(index) {
        $(this).css('animation-delay', (index * 0.1) + 's');
        $(this).addClass('animate-fade-in');
    });
});
</script>
{% endblock %}
