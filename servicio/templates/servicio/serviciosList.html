{% for servicio in servicios %}
<tr>
  <td>{{ servicio.pk }}</td>
  <td>{{ servicio.cliente.nombre }} {{ servicio.cliente.apellido }}</td>
  <td>{{ servicio.metros2 }} m²</td>
  <td>
    {% if servicio.getTipo == 'Determinado' %} 
    <span class="badge badge-determinado">
      <span class="badge-with-icon">Determinado</span>
    </span></td>
    {% elif servicio.getTipo == 'Eventual' %}
    <span class="badge badge-eventual">
      <span class="badge-with-icon">Eventual</span>
    </span></td>
    {% endif %}
  <td>
    {% if servicio.getEstado == 'Presupuestado' %}
    <span class="badge badge-presupuestado">
      <span class="badge-with-icon">Presupuestado</span>
    </span>
    {% elif servicio.getEstado == 'En Curso' %}
    <span class="badge badge-en-curso">
      <span class="badge-with-icon">En Curso</span>
    </span>
    {% elif servicio.getEstado == 'Contratado' %}
    <span class="badge badge-contratado">
      <span class="badge-with-icon">{{ servicio.getEstado }}</span>
    </span>
    {% elif servicio.getEstado == 'Finalizado' %}
    <span class="badge badge-finalizado">
      <span class="badge-with-icon">{{ servicio.getEstado }}</span>
    </span>
    {% elif servicio.getEstado == 'Cancelado' %}
    <span class="badge badge-cancelado">
      <span class="badge-with-icon">{{ servicio.getEstado }}</span>
    </span>
    {% else %}
    <span class="badge badge-pendiente">
      <span class="badge-with-icon">{{ servicio.getEstado }}</span>
    </span>
    {% endif %}
  </td>
  <td>{{ servicio.fecha_inicio|date:"d-m-Y" }}</td>
  <td>{{ servicio.fecha_finaliza|date:"d-m-Y" }}</td>
  <td>{{ servicio.getImporteTotalFormateado }}</td>
  <td>
    <button class="btn btn-sm btn-outline-primary me-1 btn-detalle" style="margin-bottom: 4px;"
      data-url="{% url 'canvasServicio' servicio.pk %}" data-bs-toggle="tooltip" data-bs-placement="top"
      title="Ver detalles del servicio">
      <i class="bi bi-eye"></i>
    </button>

    {% if servicio.getEstado == 'Presupuestado' %}
    <a href="{% url 'modificarPresupuesto' servicio.pk %}" style="margin-bottom: 4px;"
      class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="tooltip" data-bs-placement="top"
      title="Modificar presupuesto">
      <i class="bi bi-pencil-square"></i>
    </a>

    <a href="{% url 'contratarServicio' servicio.pk %}" style="margin-bottom: 4px;"
      class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="tooltip" data-bs-placement="top"
      title="Contratar servicio">
      <i class="bi bi-file-earmark-check-fill"></i>
    </a>

    <button type="button" class="btn btn-sm btn-outline-primary me-1" onclick="mostrarModalCancelacion({{ servicio.pk }})">
      <i class="bi bi-trash"></i>
    </button>  
    {% endif %}

    <a target="_blank" href="{% url 'pdfImprimir' servicio.pk %}" style="margin-bottom: 4px;"
      class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" data-bs-placement="top" title="Imprimir">
      <i class="bi bi-printer"></i>
    </a>
  </td>
</tr>
{% empty %}
<tr>
  <td colspan="9" class="text-center text-muted">No hay resultados</td>
</tr>
{% endfor %}

<!-- Modal de confirmación de cancelación -->
<div class="modal-overlay" id="cancelModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Cancelar Servicio</h3>
        </div>
        <div class="modal-body">
            <div class="confirmation-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
            </div>
            <p class="modal-text" id="cancelModalText">¿Está seguro que desea cancelar este servicio?</p>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-sm  btn-outline-primary me-1" onclick="cerrarModalCancelacion()">Cancelar</button>
            <form method="POST" id="formCancelarServicio">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-danger me-1" style="padding-inline: 30px;">Confirmar Cancelación</button>
            </form>
        </div>
    </div>
</div>

<script>
    function mostrarModalCancelacion(servicioId) {
        const modal = document.getElementById('cancelModal');
        const form = document.getElementById('formCancelarServicio');
        form.action = "{% url 'cancelarServicio' 0 %}".replace("0", servicioId);
        modal.style.display = 'flex';
    }
    
    function cerrarModalCancelacion() {
        const modal = document.getElementById('cancelModal');
        modal.style.display = 'none';
    }
    
    // Cerrar modal al hacer clic fuera
    document.getElementById('cancelModal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.style.display = 'none';
        }
    });
</script>
