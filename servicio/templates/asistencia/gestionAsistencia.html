{% extends 'layouts/baseGestion.html' %}
{% load static %}
{% block titleNavegador %}SendaRC - Gestión de Asistencias{% endblock %}
{% block title %}
<h1>Gestión de Asistencias</h1>
<p>Buscar servicio y registrar asistencias pendientes</p>
{% endblock %}
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-success mt-2">{{ message }}</div>
    {% endfor %}
{% endif %}
{% block listado %}
<form method="get" class="mb-4">
    <div class="row g-2 align-items-center">
        <div class="col-md-6">
            <select id="servicio_id" name="servicio_id" class="form-select" required>
                <option value="">Seleccione un servicio...</option>
                {% for servicio in servicios %}
                <option value="{{ servicio.id }}"
                    {% if servicio_seleccionado and servicio_seleccionado.id == servicio.id %}selected{% endif %}>
                    {{ servicio.id }} - {{ servicio.cliente.nombre }} {{ servicio.cliente.apellido }} - {{ servicio.direccion }} - {{ servicio.fecha_inicio }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-search"></i> Buscar
            </button>
        </div>
    </div>
</form>

<div class="card">
{% if servicio_seleccionado %}
    <div class="card-header bg-info text-white">
        <i class="bi bi-calendar-check me-2"></i> Asistencia pendiente <strong>{{ servicio_seleccionado.nombre }}</strong>
    </div>
    <div class="card-body">
        {% if servicio_seleccionado.estado == 6 %}
        <div class="alert alert-warning">
            El servicio seleccionado está finalizado. No se pueden registrar nuevas asistencias.
        </div>
        {%else %}
                {% if dias_pendientes %}
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Dia</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dia in dias_pendientes %}
                        <tr>
                            <td>{{ dia|date:"d/m/Y" }}</td>
                            <td>{{ dia|date:"l" }}</td>
                            <td>
                                <a href="{% url 'registroAsistencia' servicio_seleccionado.id %}?fecha={{ dia|date:'Y-m-d' }}" class="btn btn-success btn-sm">
                                <i class="bi bi-pencil-square"></i> Registrar Asistencia
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="alert alert-success">
                    No hay días pendientes de asistencia para este servicio.
                </div>
                {% endif %}
        {% endif %}
        </div>
    </div>
<div class="card mt-4">
    <div class="card-header bg-success text-white">
        <i class="bi bi-calendar-check me-2"></i>Asistencias Cerradas <strong>{{ servicio_seleccionado.nombre }}</strong>
    </div>
    <div class="card-body">
        {% if dias_registrados %}
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Dia</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody>
                {% for dia in dias_registrados %}
                <tr>
                    <td>{{ dia|date:"d/m/Y" }}</td>
                    <td>{{ dia|date:"l" }}</td>
                    <td>
                        <span class="badge bg-secondary">Cerrado</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="alert alert-info">
            No hay días con registro cerrado para este servicio.
        </div>
        {% endif %}
    </div>
</div>
{% endif %}
<!-- Toast de éxito estilo shadcn -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1055;">
  {% if messages %}
    {% for message in messages %}
      <div id="toastExito" class="toast toast-shadcn toast-success" role="alert" aria-live="assertive" aria-atomic="true" style="display:none; min-width: 350px;">
        <div class="toast-header-shadcn d-flex align-items-center justify-content-between" style="padding: 1rem 1.25rem;">
          <div class="toast-content" style="padding-right: 1rem;">
            <div class="toast-title fw-bold mb-1">Éxito</div>
            <div class="toast-message text-secondary">{{ message }}</div>
          </div>
          <button type="button" class="toast-close ms-3" onclick="document.getElementById('toastExito').style.display='none';" aria-label="Cerrar" style="background: none; border: none;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
    {% endfor %}
  {% endif %}
</div>
{% endblock %}
{% block extrajs %}
<script>
$(document).ready(function() {
    $('#servicio_id').select2({
        placeholder: "Seleccione un servicio...",
        allowClear: true,
        language: {
            noResults: function() {
                return "No se encuentra el servicio";
            }
        }
    });
    if ($('#toastExito').length) {
        $('#toastExito').fadeIn();
        setTimeout(function() {
            $('#toastExito').fadeOut();
        }, 3500);
    }
});
</script>

{% endblock %}